<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>ElasticSearch开发手册 - shaway</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="shaway"><meta name="msapplication-TileImage" content="/images/logo/sasuke.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="shaway"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="ElasticSearch开发手册"><meta property="og:type" content="blog"><meta property="og:title" content="ElasticSearch开发手册"><meta property="og:url" content="https://shawayl.github.io/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/"><meta property="og:site_name" content="shaway"><meta property="og:description" content="ElasticSearch开发手册"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://shawayl.github.io/images/cover/8a7916050d0fef4c0681baf75b9b067.jpg"><meta property="article:published_time" content="2022-11-02T08:46:00.000Z"><meta property="article:modified_time" content="2022-11-02T08:46:00.000Z"><meta property="article:author" content="shaway"><meta property="article:tag" content="数据库"><meta property="article:tag" content="ElasticSearch"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://shawayl.github.io/images/cover/8a7916050d0fef4c0681baf75b9b067.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://shawayl.github.io/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/"},"headline":"ElasticSearch开发手册","image":["https://shawayl.github.io/images/cover/8a7916050d0fef4c0681baf75b9b067.jpg"],"datePublished":"2022-11-02T08:46:00.000Z","dateModified":"2022-11-02T08:46:00.000Z","author":{"@type":"Person","name":"shaway"},"publisher":{"@type":"Organization","name":"shaway","logo":{"@type":"ImageObject","url":"https://shawayl.github.io/images/logo/sasuke.png"}},"description":"ElasticSearch开发手册"}</script><link rel="canonical" href="https://shawayl.github.io/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/"><link rel="icon" href="/images/logo/sasuke.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo/sasuke.png" alt="shaway" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="repositories" href="https://github.com/ShawayL/HexoBlog"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/images/cover/8a7916050d0fef4c0681baf75b9b067.jpg" alt="ElasticSearch开发手册"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-11-02T08:46:00.000Z" title="11/2/2022, 8:46:00 AM">2022-11-02</time>发表</span><span class="level-item"><time dateTime="2022-11-02T08:46:00.000Z" title="11/2/2022, 8:46:00 AM">2022-11-02</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span> / </span><a class="link-muted" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/ElasticSearch/">ElasticSearch</a></span><span class="level-item">1 小时读完 (大约8284个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">ElasticSearch开发手册</h1><div class="content"><h2 id="ElasticSearch-开发手册"><a href="#ElasticSearch-开发手册" class="headerlink" title="ElasticSearch 开发手册"></a>ElasticSearch 开发手册</h2><p>作者:<a target="_blank" rel="noopener" href="https://github.com/appolostar">appolostar</a></p>
<p><strong>开源的高扩展的分布式全文搜索引擎</strong></p>
<h3 id="elasticsearch与数据库的类比"><a href="#elasticsearch与数据库的类比" class="headerlink" title="elasticsearch与数据库的类比"></a>elasticsearch与数据库的类比</h3><table>
<thead>
<tr>
<th>关系型数据库（比如Mysql）</th>
<th>非关系型数据库（Elasticsearch）</th>
</tr>
</thead>
<tbody><tr>
<td>数据库Database</td>
<td>索引Index</td>
</tr>
<tr>
<td>表Table</td>
<td>类型Type（7.0之后移除）</td>
</tr>
<tr>
<td>数据行Row</td>
<td>文档Document</td>
</tr>
<tr>
<td>数据列Column</td>
<td>字段Field</td>
</tr>
<tr>
<td>约束 Schema</td>
<td>映射Mapping</td>
</tr>
</tbody></table>
<h3 id="1、index、type的初衷"><a href="#1、index、type的初衷" class="headerlink" title="1、index、type的初衷"></a><strong>1、index、type的初衷</strong></h3><p>之前es将index、type类比于<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93&spm=1001.2101.3001.7020">关系型数据库</a>（例如mysql）中database、table，这么考虑的目的是“方便管理数据之间的关系”。</p>
<p>【本来为了方便管理数据之间的关系，类比database-table 设计了index-type模型】</p>
<h3 id="2、为什么现在要移除type？"><a href="#2、为什么现在要移除type？" class="headerlink" title="2、为什么现在要移除type？"></a><strong>2、为什么现在要移除type？</strong></h3><p>2.1 在关系型数据库中table是独立的（独立存储），但es中同一个index中不同type是存储在同一个索引中的（lucene的索引文件），因此不同type中相同名字的字段的定义（mapping）必须一致。</p>
<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20221101094427673.png" class="" title="image-20221101094427673">

<h3 id="ES存入数据和搜索数据机制"><a href="#ES存入数据和搜索数据机制" class="headerlink" title="ES存入数据和搜索数据机制"></a>ES存入数据和搜索数据机制</h3><img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20221101094955423.png" class="" title="image-20221101094955423">

<p>(1)索引对象(blog):存储数据的表结构,任何搜索数据,存放在索引对象上<br>(2)映射(mapping):数据如何存放在索引对象上,需要有一个映射配置,包括数据类型,是否存储,是否分词等<br>(3)文档(document):一条数据记录,存在索引对象上<br>(4)文档类型(type):一个索引对象,存放多种类型数据,数据用文档类型进行标识什么是分片</p>
<p>什么是分片</p>
<p>Elasticsearch集群允许系统存储的数据量超过单机容量，这是通过shard实现的。在一个索引index中，数据（document）被分片处理（sharding）到多个分片上。也就是说：每个分片都保存了全部数据中的一部分。</p>
<pre><code>    一个分片是一个 Lucene 的实例，它本身就是一个完整的搜索引擎。文档被存储到分片内，但应用程序直接与索引而不是与分片进行交互。
</code></pre>
<p>什么是副本<br>说明</p>
<pre><code>    为了解决访问压力过大时单机无法处理所有请求的问题，Elasticsearch集群引入了副本策略replica。副本策略对index中的每个分片创建冗余的副本。
</code></pre>
<p>副本的作用如下：</p>
<ol>
<li><p>提高系统容错性</p>
<pre><code> 当分片所在的机器宕机时，Elasticsearch可以使用其副本进行恢复，从而避免数据丢失。
</code></pre>
</li>
<li><p>提高ES查询效率</p>
<pre><code> 处理查询时，ES会把副本分片和主分片公平对待，将查询请求负载均衡到副本分片和主分片。
</code></pre>
</li>
</ol>
<p>副本分片是越多越好吗？</p>
<p>答案当然是 no ，原因有以下两点：</p>
<p>（1）多个 replica 可以提升搜索操作的吞吐量和性能，但是如果只是在相同节点数目的集群上增加更多的副本分片并不能提高性能，因为每个分片从节点上获得的资源会变少，这个时候你就需要增加更多的硬件资源来提升吞吐量。</p>
<p>（2）更多的副本分片数提高了数据冗余量，保证了数据的完整性，但是根据上边主副分片之间的交互原理可知，分片间的数据同步会占用一定的网络带宽，影响效率，所以索引的分片数和副本数也不是越多越好。</p>
<p> 一个节点就是集群中的一个服务器，也可以理解为，一个节点就是一个ES，作为集群的一部分，他储存数据，参与集群的索引和搜索功能，和集群类似，一个节点也是由一个名字来标识的，默认情况下，这个名字可以随意起，并且会在启动的时候赋予节点这个名字，</p>
<pre><code>    一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫 做 “elasticsearch” 的集群中，这意味着，如果你在你的网络中启动了 若干个节点 ，并假定它们 能够相互发现彼此 ， 它们将会 自动地形成并加入 到一个叫做 “elasticsearch” 的集群中。
</code></pre>
<p> 1.首先准备三台es服务器，我没有三台电脑，就一台电脑上启动三个es服务器，把我们原先的es文件夹复制三份，</p>
<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20221101134333404.png" class="" title="image-20221101134333404">

<p>2、 在yml文件中设置</p>
<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20221101134425178.png" class="" title="image-20221101134425178">

<p>这里我设置了三个节点组成的集群，如果想设置多个，就多创建几个服务器文件夹，然后修改里面的配置文件，并且每个node的端口号和名字都不能一样，设置各个node可以互相发现即可。</p>
<p> cluster-2和cluster-3和cluster-1是一样的操作。</p>
<p>​    3.当我们修改好了配置文件和创建新的服务器后，每个文件夹下的data目录里面一定要是空的，不能带任何内容。</p>
<p>  4.我们把三个es服务器都启动</p>
<p>5.连接上es-header，grunt server，登陆head界面</p>
<p>​       输入我们服务器的端口号，这里我设置的是9201，9202，9203，结果都是一样的。</p>
<p>​       他们三个端口号的内容都是相同的，储存着一样的内容</p>
<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20221101135451628.png" class="" title="image-20221101135451628">

<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20221101135614173.png" class="" title="image-20221101135614173">

<p>一个节点在访问量和搜索量非常大的情况下，可能就会非常慢，或者某个节点中的分片负载太严重挂掉，而设置了集群，我们索引库的分片就会分散在各个分节点上，而且每个节点储存的分片是不相同的（相同的原分片和副本分片不会出现在同一个节点身上），这样就可以保证，我们大量用户搜索或者访问的时候，把我们的压力分散到每一个节点上<br><strong>示例1：启动2个ES节点。创建5个分片，1个副本</strong></p>
<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20221101135827614.png" class="" title="image-20221101135827614">

<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20221101135900557.png" class="" title="image-20221101135900557">

<p> 上图中，黄色的代表主分片，绿色的是副本。可以发现，分片与其副本不在同一个节点内。这是非常合理的，因为副本本来就是主分片的备胎，当主分片节点挂了，另外一个节点的副本将会充当主分片，如果它们在同一个节点内，副本将发挥不到作用。</p>
<p>7.分片</p>
<pre><code>   一个索引可以存储超出单个结点硬件限制的大量数据。比如，一个具有10亿文档的索引占据1TB的磁盘空间，而任 一节点都没有这样大的磁盘空间，或者单个节点处理搜索请求，响应太慢。为了解决这个问题，Elasticsearch提供 了将索引划分成多份的能力，这些份就叫做分片。当你创建一个索引的时候，你可以指定你想要的分片的数量。每个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置到集群中的任何节点上。分片很重要，主要有两方面的原因：1）允许你水平分割/扩展你的内容容量。 2）允许你在分片（潜在地，位于多个节点上）之上进行分布式的、并行的操作，进而提高性能/吞吐量。

    简单点来说就是，每个分片就包含了你索引库中的某一部分的内容，可以理解为一本书的目录（因为分片储存的就是索引），而分片是支持扩容的，当我们有大量的文档，由于内存不足，磁盘限制，速度极度下降，我们就需要扩容，这时一个节点就不够用了，所以我们需要把目录（分片）放到不同的空间中，也就是集群节点，这样当我们搜索某一个内容的时候，ES会把要查询的内容发给相关的分片，并将结果组合到一起。
</code></pre>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>基于Java语言开发的搜索引擎库类</p>
<p>官网：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/">免费且开放的搜索：Elasticsearch、ELK 和 Kibana 的开发者 | Elastic</a></p>
<p>下载：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases/elasticsearch-8-3-2">Elasticsearch 8.3.2 | Elastic</a></p>
<p>解压：</p>
<p>配置环境：</p>
<p>由于es对java环境要求高，可以使用其内置的java环境，下面对其进行系统环境配置：</p>
<p>添加系统变量</p>
<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729094333356.png" class="" title="image-20220729094333356">



<p>将\elasticsearch-8.3.2\config下的主配置文件<strong>elasticsearch.yml</strong>进行修改：</p>
<p>修改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xpack.security.enabled: false</span><br><span class="line"></span><br><span class="line">ingest.geoip.downloader.enabled: false</span><br></pre></td></tr></table></figure>

<p>config&#x2F;<strong>jvm.option</strong>配置文件，调整jvm堆内存大小：</p>
<p>修改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim jvm.options</span><br><span class="line">-Xms4g</span><br><span class="line">-Xmx4g</span><br></pre></td></tr></table></figure>

<p>建议不大于内存的一半</p>
<p>Xms和Xms设置成—样</p>
<p>直接运行<strong>elasticsearch.bat</strong></p>
<p>运行<a target="_blank" rel="noopener" href="http://localhost:9200/%E6%B5%8B%E8%AF%95">http://localhost:9200/测试</a></p>
<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729100252335.png" class="" title="image-20220729100252335">

<p>如图效果正常</p>
<h3 id="客户端Kibana安装"><a href="#客户端Kibana安装" class="headerlink" title="客户端Kibana安装"></a>客户端Kibana安装</h3><p>Kibana是一个开源分析和可视化平台，旨在与Elasticsearch协同工作。</p>
<p>下载：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases/kibana-8-3-2">Kibana 8.3.2 | Elastic</a></p>
<p>解压：</p>
<p>启动\kibana-8.3.2\bin下的kibana</p>
<p>访问Kibana: <a target="_blank" rel="noopener" href="http://localhost:5601/">http://localhost:5601/</a></p>
<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729103427779.png" class="" title="image-20220729103427779">

<p>出现该界面启动成功</p>
<h3 id="ElasticSearch基本概念"><a href="#ElasticSearch基本概念" class="headerlink" title="ElasticSearch基本概念"></a>ElasticSearch基本概念</h3><ul>
<li>传统关系型数据库和Elasticsearch的区别</li>
</ul>
<p>在Elasticsearch中，文档归属于一种 类型(type) ,而这些类型存在于 索引(index)中，类比传统关系型数据库：</p>
<table>
<thead>
<tr>
<th>Relational DB</th>
<th>Databases</th>
<th>Tables</th>
<th>Rows</th>
<th>Columns</th>
</tr>
</thead>
<tbody><tr>
<td>关系型数据库</td>
<td>数据库</td>
<td>表</td>
<td>行</td>
<td>列</td>
</tr>
<tr>
<td>Elasticsearch</td>
<td>Indices</td>
<td>Types</td>
<td>Documents</td>
<td>Fields</td>
</tr>
<tr>
<td>Elasticsearch</td>
<td>索引</td>
<td>类型</td>
<td>文档</td>
<td>域</td>
</tr>
</tbody></table>
<p>在Elasticsearch中，所有的字段缺省都建了索引。 也就是说每一个字段都有一个倒排索引，用于快速查询。<br>es支持http协议（json格式）（9200端口）、thrift、servlet、memcached、zeroMQ等的传输协议（通过插件方式集成）。传统关系型数据库不支持。<br>es支持分片和复制，从而方便水平分割和扩展，复制保证了es的高可用与高吞吐。</p>
<ul>
<li>索引（Index）</li>
</ul>
<p>一个索引就是一个拥有几分相似特征的文档的集合。比如说，可以有一个客户数据的索引，另一个产品 目录的索引，还有一个订单数据的索引。 一个索引由一个名字来标识（必须全部是小写字母的），并且当我们要对对应于这个索引中的文档进行 索引、搜索、更新和删除的时候，都要使用到这个名字。</p>
<ul>
<li>文档（Document）</li>
</ul>
<p> Elasticsearch是面向文档的，文档是所有可搜索数据的最小单位。</p>
<p>文档会被序列化成JSON格式，保存在Elasticsearch中</p>
<p>JSON对象由字段组成</p>
<p>每个字段都有对应的字段类型(字符串&#x2F;数值&#x2F;布尔&#x2F;日期&#x2F;二进制&#x2F;范围类型) </p>
<p>每个文档都有一个Unique ID</p>
<p>可以自己指定ID或者通过Elasticsearch自动生成</p>
<p>一篇文档包含了一系列字段，类似数据库表中的一条记录</p>
<p>JSON文档，格式灵活，不需要预先定义格式</p>
<p>字段的类型可以指定或者通过Elasticsearch自动推算 支持数组&#x2F;支持嵌套</p>
<h3 id="ElasticSearch索引操作"><a href="#ElasticSearch索引操作" class="headerlink" title="ElasticSearch索引操作"></a>ElasticSearch索引操作</h3><p><strong>创建索引</strong></p>
<p>索引命名必须小写，不能以下划线开头 格式: PUT &#x2F;索引名称</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#创建索引</span><br><span class="line">PUT /es_text</span><br><span class="line">#创建索引时可以设置分片数和副本数</span><br><span class="line">PUT /es_text</span><br><span class="line">&#123;</span><br><span class="line">&quot;settings&quot; : &#123;</span><br><span class="line">&quot;number_of_shards&quot; : 3,</span><br><span class="line">&quot;number_of_replicas&quot; : 2</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#修改索引配置</span><br><span class="line">PUT /es_text/_settings</span><br><span class="line">&#123;</span><br><span class="line">&quot;index&quot; : &#123;</span><br><span class="line">&quot;number_of_replicas&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>查询索引</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#查询索引</span><br><span class="line">GET /es_db</span><br><span class="line">#es_text是否存在</span><br><span class="line">HEAD /es_db</span><br></pre></td></tr></table></figure>

<p><strong>删除索引</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /es_db</span><br></pre></td></tr></table></figure>

<h3 id="ElasticSearch文档操作"><a href="#ElasticSearch文档操作" class="headerlink" title="ElasticSearch文档操作"></a>ElasticSearch文档操作</h3><p><strong>添加文档</strong></p>
<ul>
<li>格式: [PUT | POST] &#x2F;索引名称&#x2F;[_doc | _create ]&#x2F;id</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 创建文档,指定id</span><br><span class="line"># 如果id不存在，创建新的文档，否则先删除现有文档，再创建新的文档，版本会增加</span><br><span class="line">PUT /es_text/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;qyc&quot;,</span><br><span class="line">  &quot;sex&quot;: 1,</span><br><span class="line">  &quot;age&quot;: 23,</span><br><span class="line">  &quot;address&quot;: &quot;洛阳连飞中心大厦&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /es_text/_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;lxw&quot;,</span><br><span class="line">  &quot;sex&quot;: 1,</span><br><span class="line">  &quot;age&quot;: 25,</span><br><span class="line">  &quot;address&quot;: &quot;洛阳连飞中心大厦&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /es_text/_create/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;hxf&quot;,</span><br><span class="line">  &quot;sex&quot;: 1,</span><br><span class="line">  &quot;age&quot;: 25,</span><br><span class="line">  &quot;address&quot;: &quot;洛阳连飞中心大厦&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729112050323.png" class="" title="image-20220729112050323">

<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729111940867.png" class="" title="image-20220729111940867">

<p>POST和PUT都能起到创建&#x2F;更新的作用，PUT需要对一个具体的资源进行操作也就是要确定id才能 进行更新&#x2F;创建，而POST是可以针对整个资源集合进行操作的，如果不写id就由ES生成一个唯一id进行 创建新文档，如果填了id那就针对这个id的文档进行创建&#x2F;更新</p>
<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729112418472.png" class="" title="image-20220729112418472">

<p>Create -如果ID已经存在，会失败</p>
<p><strong>修改文档</strong></p>
<ul>
<li>全量更新，整个json都会替换，格式: [PUT | POST] &#x2F;索引名称&#x2F;_doc&#x2F;id</li>
</ul>
<p>如果文档存在，现有文档会被删除，新的文档会被索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 全量更新，替换整个json</span><br><span class="line">PUT /es_text/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;qyc&quot;,</span><br><span class="line">  &quot;sex&quot;: 1,</span><br><span class="line">  &quot;age&quot;: 23,</span><br><span class="line">&#125;</span><br><span class="line">#查询文档</span><br><span class="line">GET /es_text/_doc/1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729112942346.png" class="" title="image-20220729112942346">

<ul>
<li>使用update部分更新，格式: POST &#x2F;索引名称&#x2F;update&#x2F;id update</li>
</ul>
<p>不会删除原来的文档，而是实现真正的数据更新</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 部分更新：在原有文档上更新</span><br><span class="line"># Update -文档必须已经存在，更新只会对相应字段做增量修改</span><br><span class="line">POST /es_text/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;:&#123;</span><br><span class="line">    &quot;age&quot;: 24</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /es_text/_doc/1</span><br></pre></td></tr></table></figure>

<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729113311040.png" class="" title="image-20220729113311040">

<ul>
<li>使用 _update_by_query 更新文档</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /es_text/_update_by_query</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;_id&quot;: 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;script&quot;: &#123;</span><br><span class="line">  &quot;source&quot;: &quot;ctx._source.age = 22&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /es_text/_doc/1</span><br></pre></td></tr></table></figure>

<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729113838265.png" class="" title="image-20220729113838265">

<p><strong>查询文档</strong></p>
<p>根据id查询文档，格式: GET &#x2F;索引名称&#x2F;doc&#x2F;id</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /es_text/_doc/1</span><br></pre></td></tr></table></figure>

<p>条件查询 search，格式： &#x2F;索引名称&#x2F;doc&#x2F;_search</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查询前10条文档（默认）</span><br><span class="line">GET /es_text/_doc/_search</span><br></pre></td></tr></table></figure>

<p>ES Search API提供了两种条件查询搜索方式： </p>
<p>REST风格的请求URI，直接将参数带过去 （8.x之后不再提供）</p>
<p>封装到request body中，这种方式可以定义更加易读的JSON格式（后面写了）</p>
<p><strong>删除文档</strong></p>
<ul>
<li>格式: DELETE &#x2F;索引名称&#x2F;_doc&#x2F;id</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /es_db/_doc/1</span><br></pre></td></tr></table></figure>

<p><strong>ElasticSearch文档批量操作</strong></p>
<p>批量操作可以减少网络连接所产生的开销，提升性能 支持在一次API调用中，对不同的索引进行操作 可以再URI中指定Index，也可以在请求的Payload中进行 操作中单条操作失败，并不会影响其他操作 返回结果包括了每一条操作执行的结果</p>
<p><strong>批量写入</strong></p>
<ul>
<li>批量对文档进行写操作是通过_bulk的API来实现的</li>
</ul>
<p>请求方式：POST</p>
<p>请求地址：_bulk </p>
<p>请求参数：通过_bulk操作文档，一般至少有两行参数(或偶数行参数) </p>
<p>第一行参数为指定操作的类型及操作的对象(index,type和id) </p>
<p>第二行参数才是操作的数据</p>
<p><strong>批量创建</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;es_text&quot;,&quot;_id&quot;:4&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;xxs&quot;,&quot;sex&quot;:1,&quot;age&quot;:28,&quot;address&quot;:&quot;洛阳科技大厦&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;es_text&quot;,&quot;_id&quot;:5&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;zmf&quot;,&quot;sex&quot;:1,&quot;age&quot;:29,&quot;address&quot;:&quot;洛阳科技中心大厦&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>批量替换</strong></p>
<p>如果原文档不存在，则是创建 </p>
<p>如果原文档存在，则是替换(全量修改原文档)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_index&quot;:&quot;es_text&quot;,&quot;_id&quot;:4&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;xxs&quot;,&quot;sex&quot;:1,&quot;age&quot;:28,&quot;address&quot;:&quot;洛阳科技大厦&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_index&quot;:&quot;es_text&quot;,&quot;_id&quot;:5&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;zmf&quot;,&quot;sex&quot;:1,&quot;age&quot;:29,&quot;address&quot;:&quot;洛阳科技中心大厦&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>批量修改</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;es_text&quot;,&quot;_id&quot;:4&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;:&#123;&quot;name&quot;:&quot;zmf&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;es_text&quot;,&quot;_id&quot;:5&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;:&#123;&quot;name&quot;:&quot;xxs&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>批量删除</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;es_text&quot;,&quot;_id&quot;:6&#125;&#125;</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;es_text&quot;,&quot;_id&quot;:7&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>组合应用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_index&quot;:&quot;es_text&quot;,&quot;_id&quot;:6&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wsq&quot;,&quot;sex&quot;:1,&quot;age&quot;:28,&quot;address&quot;:&quot;洛阳科技大厦&quot;&#125;</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;es_text&quot;,&quot;_id&quot;:6&#125;&#125;</span><br></pre></td></tr></table></figure>

<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729142947144.png" class="" title="image-20220729142947144">

<p><strong>批量读取</strong></p>
<p>es的批量查询可以使用mget和msearch两种。其中mget是需要我们知道它的id，可以指定不同的 index，也可以指定返回值source。msearch可以通过字段查询来进行一个批量的查找。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#可以通过ID批量获取不同index和type的数据</span><br><span class="line">GET _mget</span><br><span class="line">&#123;</span><br><span class="line">&quot;docs&quot;: [</span><br><span class="line">&#123;</span><br><span class="line">&quot;_index&quot;: &quot;es_db&quot;,</span><br><span class="line">&quot;_id&quot;: 1</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">&quot;_index&quot;: &quot;es_text&quot;,</span><br><span class="line">&quot;_id&quot;: 4</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#可以通过ID批量获取es_db的数据</span><br><span class="line">GET /es_text/_mget</span><br><span class="line">&#123;</span><br><span class="line">&quot;docs&quot;: [</span><br><span class="line">&#123;</span><br><span class="line">&quot;_id&quot;: 1</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">&quot;_id&quot;: 4</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">#简化后</span><br><span class="line">GET /es_text/_mget</span><br><span class="line">&#123;</span><br><span class="line">&quot;ids&quot;:[&quot;1&quot;,&quot;2&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ES检索原理分析"><a href="#ES检索原理分析" class="headerlink" title="ES检索原理分析"></a>ES检索原理分析</h3><h4 id="索引的原理"><a href="#索引的原理" class="headerlink" title="索引的原理"></a>索引的原理</h4><p>索引是加速数据查询的重要手段，其核心原理是通过不断的缩小想要获取数据的范围来筛选出最终想要 的结果，同时把随机的事件变成顺序的事件。</p>
<h4 id="磁盘IO与预读"><a href="#磁盘IO与预读" class="headerlink" title="磁盘IO与预读"></a>磁盘IO与预读</h4><p>磁盘IO是程序设计中非常高昂的操作，也是影响程序性能的重要因素，因此应当尽量避免过多的磁盘 IO，有效的利用内存可以大大的提升程序的性能。在操作系统层面，发生一次IO时，不光把当前磁盘地 址的数据，而是把相邻的数据也都读取到内存缓冲区内，局部预读性原理告诉我们，当计算机访问一个 地址的数据的时候，与其相邻的数据也会很快被访问到。每一次IO读取的数据我们称之为一页(page)。 具体一页有多大数据跟操作系统有关，一般为4k或8k，也就是我们读取一页内的数据时候，实际上才发 生了一次IO，这个理论对于索引的数据结构设计非常有帮助。</p>
<h4 id="ES倒排索引"><a href="#ES倒排索引" class="headerlink" title="ES倒排索引"></a>ES倒排索引</h4><p>相当于将存入数据分词器拆分，根据词出现的频率给分，得分进行一个词组排序由高到低</p>
<p>为了进一步提升索引的效率索引结构</p>
<p>相当于将词项索引单词词典（Term Dictionary)[记录所有文档的单词，记录单词到倒排列表的关联关系]</p>
<p>然后根据词典找到倒排列表   (Posting List)[记录了单词对应的文档结合，由倒排索引项组成]</p>
<p>倒排索引项(Posting)：</p>
<ul>
<li>文档ID 词频TF–该单词在文档中出现的次数，用于相关性评分 </li>
<li>位置(Position)-单词在文档中分词的位置。用于短语搜索（match phrase query)</li>
<li>偏移(Offset)-记录单词的开始结束位置，实现高亮显示</li>
</ul>
<h4 id="ES高级查询Query-DSL"><a href="#ES高级查询Query-DSL" class="headerlink" title="ES高级查询Query DSL"></a>ES高级查询Query DSL</h4><p>ES中提供了一种强大的检索数据方式,这种检索方式称之为Query DSL（Domain Specified Language） , Query DSL是利用Rest API传递JSON格式的请求体(RequestBody)数据与ES进行交互，这种方式的丰富 查询语法让ES检索变得更强大，更简洁。</p>
<p><strong>主流写法</strong></p>
<h4 id="查询所有-match-all"><a href="#查询所有-match-all" class="headerlink" title="查询所有 match_all"></a>查询所有 match_all</h4><p>使用match_all，默认只会返回10条数据。<br>原因：_search查询默认采用的是分页查询，每页记录数size的默认值为10。如果想显示更多数据，指定size条数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 100</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分页查询form"><a href="#分页查询form" class="headerlink" title="分页查询form"></a>分页查询form</h4><p>from 关键字: 用来指定起始返回位置，和size关键字连用可实现分页效果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /es_db/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 3,</span><br><span class="line">  &quot;from&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>size不能无限大</p>
<p>默认窗口大小为10000，该窗口大小为from数值与size之和</p>
<p>查询结果窗口可以对index.max_result_window进行设置</p>
<p>设置方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /es_text/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index.max_result_window&quot;:&quot;20000&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这样对内存的消耗巨大，引入了分页查询</p>
<p><strong>分页查询Scroll</strong></p>
<p>改动index.max_result_window参数值的大小，只能解决一时的问题，当索引的数据量持续增长时，在 查询全量数据时还是会出现问题。而且会增加ES服务器内存大结果集消耗完的风险。最佳实践还是根据 异常提示中的采用scroll api更高效的请求大量数据集。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#查询命令中新增scroll=1m,说明采用游标查询，保持游标查询窗口一分钟。</span><br><span class="line">#这里由于测试数据量不够，所以size值设置为2。</span><br><span class="line">#实际使用中为了减少游标查询的次数，可以将值适当增大，比如设置为1000。</span><br><span class="line">GET /es_text/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125;&#125;,</span><br><span class="line">	&quot;size&quot;: 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查询结果如图</p>
<p>返回了_scroll_id 的值</p>
<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729151453600.png" class="" title="image-20220729151453600">

<p>可以多次根据scroll_id游标查询，直到没有数据返回则结束查询。采用游标查询索引全量数据，更安全高 效，限制了单次对内存的消耗。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># scroll_id 的值就是上一个请求中返回的 _scroll_id 的值</span><br><span class="line">GET /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">  &quot;scroll&quot;:&quot;1m&quot;,</span><br><span class="line">  &quot;scroll_id&quot;: </span><br><span class="line">  &quot;FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFklLNUVUcU9qVEpDVExMMVctbGdMWWcAAAAAAAAkBRZUdEllN29zQ1RMR1VIYkd1Q2NsUWJn&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="指定字段排序sort"><a href="#指定字段排序sort" class="headerlink" title="指定字段排序sort"></a>指定字段排序sort</h4><p>可以根据年龄进行排序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;age&quot;: &quot;desc&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#排序，分页</span><br><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;age&quot;: &quot;desc&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;from&quot;: 2,</span><br><span class="line">  &quot;size&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="返回指定字段-source"><a href="#返回指定字段-source" class="headerlink" title="返回指定字段 _source"></a>返回指定字段 _source</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_source&quot;: [&quot;name&quot;,&quot;address&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="模糊匹配-match"><a href="#模糊匹配-match" class="headerlink" title="模糊匹配 match"></a>模糊匹配 match</h4><p>match在匹配时会对所查找的关键词进行分词，然后按分词匹配查找<br>match支持以下参数：</p>
<p>query : 指定匹配的值<br>operator : 匹配条件类型<br>and : 条件分词后都要匹配<br>or : 条件分词后有一个匹配即可(默认)<br>minmum_should_match : 最低匹配度，即条件在倒排索引中最低的匹配度</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#模糊匹配 match   分词后or的效果</span><br><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &quot;洛阳大厦&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 分词后 and的效果</span><br><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;洛阳中心&quot;,</span><br><span class="line">        &quot;operator&quot;: &quot;AND&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/2022/11/02/ElasticSearch%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/image-20220729155417372.png" class="" title="image-20220729155417372">

<h4 id="短语查询-match-phrase"><a href="#短语查询-match-phrase" class="headerlink" title="短语查询 match_phrase"></a>短语查询 match_phrase</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;qyc洛阳&quot;,</span><br><span class="line">      &quot;fields&quot;: [</span><br><span class="line">        &quot;address&quot;,</span><br><span class="line">        &quot;name&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">注意：字段类型分词,将查询条件分词之后进行查询，如果该字段不分词就会将查询条件作为整体进行查询。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="全字段搜索-query-string"><a href="#全字段搜索-query-string" class="headerlink" title="全字段搜索 query_string"></a>全字段搜索 query_string</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#未指定字段查询</span><br><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;xxs OR 洛阳&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#指定单个字段查询、</span><br><span class="line">#Query String</span><br><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;default_field&quot;: &quot;address&quot;,</span><br><span class="line">      &quot;query&quot;: &quot;xxs OR 洛阳&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#指定多个字段查询</span><br><span class="line">GET /es_db/_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">&quot;query_string&quot;: &#123;</span><br><span class="line">&quot;fields&quot;: [&quot;name&quot;,&quot;address&quot;],</span><br><span class="line">&quot;query&quot;: &quot;xxs OR ( 洛阳 AND 大厦)&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="关键词查询Term"><a href="#关键词查询Term" class="headerlink" title="关键词查询Term"></a>关键词查询Term</h4><p>Term用来使用关键词查询(精确匹配),一般模糊查找的时候，多用 match，而精确查找时可以使用term。 ES中默认使用分词器为标准分词器(StandardAnalyzer),标准分词器对于英文单词分词,对于中文单 字分词。</p>
<p> 在ES的Mapping Type 中 keyword , date ,integer, long , double , boolean or ip 这些类型不分 词，只有text类型分词。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#关键字查询 term</span><br><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;中心大厦&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 采用term精确查询, 查询字段映射类型为keyword</span><br><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;address.keyword&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;中心大厦&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">在ES中，Term查询，对输入不做分词。会将输入作为一个整体，在倒排索引中查找准确的词项，并且使用相关度算分公式为每个包含该词项的文档进行相关度算分。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="前缀查询-prefix"><a href="#前缀查询-prefix" class="headerlink" title="前缀查询 prefix"></a>前缀查询 prefix</h4><ul>
<li>它不会分析要搜索字符串，传入的前缀就是想要查找的前缀</li>
<li>默认状态下，前缀查询不做相关度分数计算，它只是将所有匹配的文档返回，然后赋予所有相关分数值为1。它的行为更像是一个过滤器而不是查询。两者实际的区别就是过滤器是可以被缓存的，而前缀查询不行。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;prefix&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;洛阳&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="通配符查询-wildcard"><a href="#通配符查询-wildcard" class="headerlink" title="通配符查询 wildcard"></a>通配符查询 wildcard</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;wildcard&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;*飞*&quot;</span><br><span class="line">      &#125;·</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="范围查询-range"><a href="#范围查询-range" class="headerlink" title="范围查询 range"></a>范围查询 range</h4><p>range：范围关键字<br>gte 大于等于<br>lte 小于等于<br>gt 大于<br>lt 小于<br>now 当前时间</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /es_db/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 25,</span><br><span class="line">        &quot;lte&quot;: 28</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="日期-range"><a href="#日期-range" class="headerlink" title="日期 range"></a>日期 range</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DELETE /product</span><br><span class="line">POST /product/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:1&#125;&#125;</span><br><span class="line">&#123;&quot;price&quot;:100,&quot;date&quot;:&quot;2021-01-01&quot;,&quot;productId&quot;:&quot;XHDK-1293&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:2&#125;&#125;</span><br><span class="line">&#123;&quot;price&quot;:200,&quot;date&quot;:&quot;2022-01-01&quot;,&quot;productId&quot;:&quot;KDKE-5421&quot;&#125;</span><br><span class="line"></span><br><span class="line">GET /product/_mapping</span><br><span class="line"></span><br><span class="line">GET /product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;date&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: &quot;now-2y&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="多-id-查询-ids"><a href="#多-id-查询-ids" class="headerlink" title="多 id 查询 ids"></a>多 id 查询 ids</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /es_db/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;ids&quot;: &#123;</span><br><span class="line">      &quot;values&quot;: [1,2]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="模糊查询-fuzzy"><a href="#模糊查询-fuzzy" class="headerlink" title="模糊查询 fuzzy"></a>模糊查询 fuzzy</h4><p>在实际的搜索中，我们有时候会打错字，从而导致搜索不到。在Elasticsearch中，我们可以使用fuzziness属性来进行模糊查询，从而达到搜索有错别字的情形。<br>fuzzy 查询会用到两个很重要的参数，fuzziness，prefix_length</p>
<p>fuzziness：表示输入的关键字通过几次操作可以转变成为ES库里面的对应field的字段<br>操作是指：新增一个字符，删除一个字符，修改一个字符，每次操作可以记做编辑距离为1，<br>如中文集团到中威集团编辑距离就是1，只需要修改一个字符；<br>该参数默认值为0，即不开启模糊查询。<br>如果fuzziness值在这里设置成2，会把编辑距离为2的东东集团也查出来。<br>prefix_length：表示限制输入关键字和ES对应查询field的内容开头的第n个字符必须完全匹配，不允许错别字匹配<br>如这里等于1，则表示开头的字必须匹配，不匹配则不返回<br>默认值也是0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;fuzzy&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;罗阳&quot;,</span><br><span class="line">        &quot;fuzziness&quot;: 1    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /es_text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;fuzzy&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;科及&quot;,</span><br><span class="line">        &quot;fuzziness&quot;: 1    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">注意: fuzzy 模糊查询 最大模糊错误 必须在0-2之间</span><br><span class="line">- 搜索关键词长度为 2，不允许存在模糊</span><br><span class="line">- 搜索关键词长度为3-5，允许1次模糊</span><br><span class="line">- 搜索关键词长度大于5，允许最大2次模糊</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="高亮-highlight"><a href="#高亮-highlight" class="headerlink" title="高亮 highlight"></a>高亮 highlight</h4><p>highlight 关键字: 可以让符合条件的文档中的关键词高亮。</p>
<ul>
<li>pre_tags 前缀标签</li>
<li>post_tags 后缀标签</li>
<li>tags_schema 设置为styled可以使用内置高亮样式</li>
<li>require_field_match 多字段高亮需要设置为false</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">示例代码</span><br><span class="line">#指定ik分词器（7.29没有8.3.2版本的需要等待插件更新）</span><br><span class="line">PUT /products</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">          &quot;analysis.analyzer.default.type&quot;: &quot;ik_max_word&quot;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /products/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;proId&quot; : &quot;2&quot;,</span><br><span class="line">  &quot;name&quot; : &quot;牛仔男外套&quot;,</span><br><span class="line">  &quot;desc&quot; : &quot;牛仔外套男装春季衣服男春装夹克修身休闲男生潮牌工装潮流头号青年春秋棒球服男 7705浅蓝常规 XL&quot;,</span><br><span class="line">  &quot;timestamp&quot; : 1576313264451,</span><br><span class="line">  &quot;createTime&quot; : &quot;2019-12-13 12:56:56&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /products/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;proId&quot; : &quot;6&quot;,</span><br><span class="line">  &quot;name&quot; : &quot;HLA海澜之家牛仔裤男&quot;,</span><br><span class="line">  &quot;desc&quot; : &quot;HLA海澜之家牛仔裤男2019时尚有型舒适HKNAD3E109A 牛仔蓝(A9)175/82A(32)&quot;,</span><br><span class="line">  &quot;timestamp&quot; : 1576314265571,</span><br><span class="line">  &quot;createTime&quot; : &quot;2019-12-18 15:56:56&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">测试</span><br><span class="line">GET /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;牛仔&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;*&quot;:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">自定义高亮 html 标签</span><br><span class="line">可以在 highlight 中使用 pre_tags 和 post_tags</span><br><span class="line">GET /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;牛仔&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;post_tags&quot;: [&quot;&lt;/span&gt;&quot;], </span><br><span class="line">    &quot;pre_tags&quot;: [&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;],</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;*&quot;:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">多字段高亮</span><br><span class="line">GET /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;牛仔&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;pre_tags&quot;: [&quot;&lt;font color=&#x27;red&#x27;&gt;&quot;],</span><br><span class="line">    &quot;post_tags&quot;: [&quot;&lt;font/&gt;&quot;],</span><br><span class="line">    &quot;require_field_match&quot;: &quot;false&quot;,</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &#123;&#125;,</span><br><span class="line">      &quot;desc&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="相关性和相关性算分"><a href="#相关性和相关性算分" class="headerlink" title="相关性和相关性算分"></a>相关性和相关性算分</h2><p><strong>搜索是用户和搜索引擎的对话，用户关心的是搜索结果的相关性</strong><br>是否可以找到所有相关的内容<br>有多少不相关的内容被返回了<br>文档的打分是否合理<br>结合业务需求，平衡结果排名<br><strong>如何衡量相关性：</strong><br>Precision(查准率)―尽可能返回较少的无关文档<br>Recall(查全率)–尽量返回较多的相关文档<br>Ranking -是否能够按照相关度进行排序</p>
<h4 id="相关性（Relevance）"><a href="#相关性（Relevance）" class="headerlink" title="相关性（Relevance）"></a>相关性（Relevance）</h4><p>搜索的相关性算分，描述了一个文档和查询语句匹配的程度。ES 会对每个匹配查询条件的结果进行算分_score。打分的本质是排序，需要把最符合用户需求的文档排在前面。ES 5之前，默认的相关性算分采用TF-IDF，现在采用BM 25。</p>
<h4 id="什么是TF-IDF"><a href="#什么是TF-IDF" class="headerlink" title="什么是TF-IDF"></a>什么是TF-IDF</h4><p>TF-IDF（term frequency–inverse document frequency）是一种用于信息检索与数据挖掘的常用加权技术。</p>
<h4 id="BM25"><a href="#BM25" class="headerlink" title="BM25"></a>BM25</h4><p>es5之后用的是这个算分</p>
<p>和经典的TF-IDF相比,当TF无限增加时，BM 25算分会趋于一个数值</p>
<h4 id="通过Explain-API查看TF-IDF"><a href="#通过Explain-API查看TF-IDF" class="headerlink" title="通过Explain API查看TF-IDF"></a>通过Explain API查看TF-IDF</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_score/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:1&#125;&#125;</span><br><span class="line">&#123;&quot;content&quot;:&quot;we use Elasticsearch to power the search&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:2&#125;&#125;</span><br><span class="line">&#123;&quot;content&quot;:&quot;we like elasticsearch&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:3&#125;&#125;</span><br><span class="line">&#123;&quot;content&quot;:&quot;Thre scoring of documents is caculated by the scoring formula&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:4&#125;&#125;</span><br><span class="line">&#123;&quot;content&quot;:&quot;you know,for search&quot;&#125;</span><br><span class="line"></span><br><span class="line">GET /test_score/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;explain&quot;: true, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &quot;elasticsearch&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Boosting"><a href="#Boosting" class="headerlink" title="Boosting"></a>Boosting</h4><p>Boosting是控制相关度的一种手段。<br>参数boost的含义：</p>
<p>当boost &gt; 1时，打分的权重相对性提升<br>当0 &lt; boost &lt;1时，打分的权重相对性降低<br>当boost &lt;0时，贡献负分<br>返回匹配positive查询的文档并降低匹配negative查询的文档相似度分。这样就可以在不排除某些文档的前提下对文档进行查询,搜索结果中存在只不过相似度分数相比正常匹配的要低;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /test_score/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;boosting&quot;: &#123;</span><br><span class="line">      &quot;positive&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &quot;elasticsearch&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative&quot;: &#123;</span><br><span class="line">         &quot;term&quot;: &#123;</span><br><span class="line">            &quot;content&quot;: &quot;like&quot;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative_boost&quot;: 0.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>希望包含了某项内容的结果不是不出现，而是排序靠后。</p>
<h4 id="布尔查询bool-Query"><a href="#布尔查询bool-Query" class="headerlink" title="布尔查询bool Query"></a>布尔查询bool Query</h4><p>一个bool查询,是一个或者多个查询子句的组合，总共包括4种子句，其中2种会影响算分，2种不影响算分。</p>
<p>must: 相当于&amp;&amp; ，必须匹配，贡献算分<br>should: 相当于|| ，选择性匹配，贡献算分<br>must_not: 相当于! ，必须不能匹配，不贡献算分<br>filter: 必须匹配，不贡献算法<br>在Elasticsearch中，有Query和 Filter两种不同的Context</p>
<p>Query Context: 相关性算分<br>Filter Context: 不需要算分 ,可以利用Cache，获得更好的性能<br>相关性并不只是全文本检索的专利，也适用于yes | no 的子句，匹配的子句越多，相关性评分<br>越高。如果多条查询子句被合并为一条复合查询语句，比如 bool查询，则每个查询子句计算得出的评分会被合并到总的相关性评分中。</p>
<h4 id="Boosting-Query"><a href="#Boosting-Query" class="headerlink" title="Boosting Query"></a>Boosting Query</h4><p>Boosting是控制相关的一种手段。可以通过指定字段的boost值影响查询结果</p>
<ul>
<li>参数boost的含义：<ul>
<li>当boost &gt; 1时，打分的权重相对性提升</li>
<li>当0 &lt; boost &lt;1时，打分的权重相对性降低</li>
<li>当boost &lt;0时，贡献负分</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">POST /blogs/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:1&#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;Apple iPad&quot;,&quot;content&quot;:&quot;Apple iPad,Apple iPad&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:2&#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;Apple iPad,Apple iPad&quot;,&quot;content&quot;:&quot;Apple iPad&quot;&#125;</span><br><span class="line"></span><br><span class="line">GET /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &#123;</span><br><span class="line">              &quot;query&quot;: &quot;apple,ipad&quot;,</span><br><span class="line">              &quot;boost&quot;: 1</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;content&quot;: &#123;</span><br><span class="line">              &quot;query&quot;: &quot;apple,ipad&quot;,</span><br><span class="line">              &quot;boost&quot;: 4</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="利用negative-boost降低相关性"><a href="#利用negative-boost降低相关性" class="headerlink" title="利用negative_boost降低相关性"></a>利用negative_boost降低相关性</h4><p>negative_boost 对 negative部分query生效<br>计算评分时,boosting部分评分不修改，negative部分query乘以negative_boost值<br>negative_boost取值:0-1.0，举例:0.3<br>对某些返回结果不满意，但又不想排除掉（ must_not)，可以考虑boosting query的negative_boost。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /news/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;boosting&quot;: &#123;</span><br><span class="line">      &quot;positive&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &quot;apple&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &quot;pie&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative_boost&quot;: 0.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="常用Mapping参数配置"><a href="#常用Mapping参数配置" class="headerlink" title="常用Mapping参数配置"></a>常用Mapping参数配置</h4><p>index: 控制当前字段是否被索引，默认为true。如果设置为false，该字段不可被搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">DELETE /user</span><br><span class="line">PUT /user</span><br><span class="line">&#123;</span><br><span class="line">&quot;mappings&quot; : &#123;</span><br><span class="line">	&quot;properties&quot; : &#123;</span><br><span class="line">	&quot;address&quot; : &#123;</span><br><span class="line">	&quot;type&quot; : &quot;text&quot;,</span><br><span class="line">	&quot;index&quot;: false</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;age&quot; : &#123;</span><br><span class="line">	&quot;type&quot; : &quot;long&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;name&quot; : &#123;</span><br><span class="line">	&quot;type&quot; : &quot;text&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">PUT /user/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;:&quot;fox&quot;,</span><br><span class="line">&quot;address&quot;:&quot;洛阳洛龙&quot;,</span><br><span class="line">&quot;age&quot;:30</span><br><span class="line">&#125;</span><br><span class="line">GET /user</span><br><span class="line">GET /user/_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">&quot;match&quot;: &#123;</span><br><span class="line">&quot;address&quot;: &quot;洛阳洛龙&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无法找到</p>
<h4 id="Dynamic-Template"><a href="#Dynamic-Template" class="headerlink" title="Dynamic Template"></a>Dynamic Template</h4><p>根据Elasticsearch识别的数据类型，结合字段名称，来动态设定字段类型 </p>
<ul>
<li>所有的字符串类型都设定成Keyword，或者关闭keyword 字段 </li>
<li>is开头的字段都设置成 boolean</li>
<li>long_开头的都设置成 long类型</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_test_index</span><br><span class="line">&#123;</span><br><span class="line">&quot;mappings&quot;: &#123;</span><br><span class="line">&quot;dynamic_templates&quot;: [</span><br><span class="line">&#123;</span><br><span class="line">&quot;full_name&quot;:&#123;</span><br><span class="line">&quot;path_match&quot;: &quot;name.*&quot;,</span><br><span class="line">&quot;path_unmatch&quot;: &quot;*.middle&quot;,</span><br><span class="line">&quot;mapping&quot;:&#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">&quot;copy_to&quot;: &quot;full_name&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">PUT /my_test_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;:&#123;</span><br><span class="line">&quot;first&quot;: &quot;John&quot;,</span><br><span class="line">&quot;middle&quot;: &quot;Winston&quot;,</span><br><span class="line">&quot;last&quot;: &quot;Lennon&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">GET /my_test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">&quot;match&quot;: &#123;</span><br><span class="line">&quot;full_name&quot;: &quot;John&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_templates&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">        &quot;strings_as_boolean&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;:&quot;string&quot;,</span><br><span class="line">          &quot;match&quot;:&quot;is*&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;boolean&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;strings_as_keywords&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;:   &quot;string&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="lndex-Template"><a href="#lndex-Template" class="headerlink" title="lndex Template"></a>lndex Template</h4><p>当一个索引被新创建时：</p>
<ul>
<li>应用Elasticsearch 默认的settings 和mappings</li>
<li>应用order数值低的lndex Template 中的设定</li>
<li>应用order高的 Index Template 中的设定，之前的设定会被覆盖</li>
<li>应用创建索引时，用户所指定的Settings和 Mappings，并覆盖之前模版中的设定</li>
</ul>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><a class="link-muted mr-2" rel="tag" href="/tags/ElasticSearch/">ElasticSearch</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/10/31/linux%E8%87%AA%E5%8A%A8%E6%8B%B7%E8%B4%9D%E4%BE%9D%E8%B5%96%E9%A1%B9/"><span class="level-item">linux自动拷贝依赖项</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#ElasticSearch-开发手册"><span class="level-left"><span class="level-item">1</span><span class="level-item">ElasticSearch 开发手册</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#elasticsearch与数据库的类比"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">elasticsearch与数据库的类比</span></span></a></li><li><a class="level is-mobile" href="#1、index、type的初衷"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">1、index、type的初衷</span></span></a></li><li><a class="level is-mobile" href="#2、为什么现在要移除type？"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">2、为什么现在要移除type？</span></span></a></li><li><a class="level is-mobile" href="#ES存入数据和搜索数据机制"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">ES存入数据和搜索数据机制</span></span></a></li><li><a class="level is-mobile" href="#安装"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">安装</span></span></a></li><li><a class="level is-mobile" href="#客户端Kibana安装"><span class="level-left"><span class="level-item">1.6</span><span class="level-item">客户端Kibana安装</span></span></a></li><li><a class="level is-mobile" href="#ElasticSearch基本概念"><span class="level-left"><span class="level-item">1.7</span><span class="level-item">ElasticSearch基本概念</span></span></a></li><li><a class="level is-mobile" href="#ElasticSearch索引操作"><span class="level-left"><span class="level-item">1.8</span><span class="level-item">ElasticSearch索引操作</span></span></a></li><li><a class="level is-mobile" href="#ElasticSearch文档操作"><span class="level-left"><span class="level-item">1.9</span><span class="level-item">ElasticSearch文档操作</span></span></a></li><li><a class="level is-mobile" href="#ES检索原理分析"><span class="level-left"><span class="level-item">1.10</span><span class="level-item">ES检索原理分析</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#索引的原理"><span class="level-left"><span class="level-item">1.10.1</span><span class="level-item">索引的原理</span></span></a></li><li><a class="level is-mobile" href="#磁盘IO与预读"><span class="level-left"><span class="level-item">1.10.2</span><span class="level-item">磁盘IO与预读</span></span></a></li><li><a class="level is-mobile" href="#ES倒排索引"><span class="level-left"><span class="level-item">1.10.3</span><span class="level-item">ES倒排索引</span></span></a></li><li><a class="level is-mobile" href="#ES高级查询Query-DSL"><span class="level-left"><span class="level-item">1.10.4</span><span class="level-item">ES高级查询Query DSL</span></span></a></li><li><a class="level is-mobile" href="#查询所有-match-all"><span class="level-left"><span class="level-item">1.10.5</span><span class="level-item">查询所有 match_all</span></span></a></li><li><a class="level is-mobile" href="#分页查询form"><span class="level-left"><span class="level-item">1.10.6</span><span class="level-item">分页查询form</span></span></a></li><li><a class="level is-mobile" href="#指定字段排序sort"><span class="level-left"><span class="level-item">1.10.7</span><span class="level-item">指定字段排序sort</span></span></a></li><li><a class="level is-mobile" href="#返回指定字段-source"><span class="level-left"><span class="level-item">1.10.8</span><span class="level-item">返回指定字段 _source</span></span></a></li><li><a class="level is-mobile" href="#模糊匹配-match"><span class="level-left"><span class="level-item">1.10.9</span><span class="level-item">模糊匹配 match</span></span></a></li><li><a class="level is-mobile" href="#短语查询-match-phrase"><span class="level-left"><span class="level-item">1.10.10</span><span class="level-item">短语查询 match_phrase</span></span></a></li><li><a class="level is-mobile" href="#全字段搜索-query-string"><span class="level-left"><span class="level-item">1.10.11</span><span class="level-item">全字段搜索 query_string</span></span></a></li><li><a class="level is-mobile" href="#关键词查询Term"><span class="level-left"><span class="level-item">1.10.12</span><span class="level-item">关键词查询Term</span></span></a></li><li><a class="level is-mobile" href="#前缀查询-prefix"><span class="level-left"><span class="level-item">1.10.13</span><span class="level-item">前缀查询 prefix</span></span></a></li><li><a class="level is-mobile" href="#通配符查询-wildcard"><span class="level-left"><span class="level-item">1.10.14</span><span class="level-item">通配符查询 wildcard</span></span></a></li><li><a class="level is-mobile" href="#范围查询-range"><span class="level-left"><span class="level-item">1.10.15</span><span class="level-item">范围查询 range</span></span></a></li><li><a class="level is-mobile" href="#日期-range"><span class="level-left"><span class="level-item">1.10.16</span><span class="level-item">日期 range</span></span></a></li><li><a class="level is-mobile" href="#多-id-查询-ids"><span class="level-left"><span class="level-item">1.10.17</span><span class="level-item">多 id 查询 ids</span></span></a></li><li><a class="level is-mobile" href="#模糊查询-fuzzy"><span class="level-left"><span class="level-item">1.10.18</span><span class="level-item">模糊查询 fuzzy</span></span></a></li><li><a class="level is-mobile" href="#高亮-highlight"><span class="level-left"><span class="level-item">1.10.19</span><span class="level-item">高亮 highlight</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#相关性和相关性算分"><span class="level-left"><span class="level-item">2</span><span class="level-item">相关性和相关性算分</span></span></a><ul class="menu-list"><ul class="menu-list"><li><a class="level is-mobile" href="#相关性（Relevance）"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">相关性（Relevance）</span></span></a></li><li><a class="level is-mobile" href="#什么是TF-IDF"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">什么是TF-IDF</span></span></a></li><li><a class="level is-mobile" href="#BM25"><span class="level-left"><span class="level-item">2.1.3</span><span class="level-item">BM25</span></span></a></li><li><a class="level is-mobile" href="#通过Explain-API查看TF-IDF"><span class="level-left"><span class="level-item">2.1.4</span><span class="level-item">通过Explain API查看TF-IDF</span></span></a></li><li><a class="level is-mobile" href="#Boosting"><span class="level-left"><span class="level-item">2.1.5</span><span class="level-item">Boosting</span></span></a></li><li><a class="level is-mobile" href="#布尔查询bool-Query"><span class="level-left"><span class="level-item">2.1.6</span><span class="level-item">布尔查询bool Query</span></span></a></li><li><a class="level is-mobile" href="#Boosting-Query"><span class="level-left"><span class="level-item">2.1.7</span><span class="level-item">Boosting Query</span></span></a></li><li><a class="level is-mobile" href="#利用negative-boost降低相关性"><span class="level-left"><span class="level-item">2.1.8</span><span class="level-item">利用negative_boost降低相关性</span></span></a></li><li><a class="level is-mobile" href="#常用Mapping参数配置"><span class="level-left"><span class="level-item">2.1.9</span><span class="level-item">常用Mapping参数配置</span></span></a></li><li><a class="level is-mobile" href="#Dynamic-Template"><span class="level-left"><span class="level-item">2.1.10</span><span class="level-item">Dynamic Template</span></span></a></li><li><a class="level is-mobile" href="#lndex-Template"><span class="level-left"><span class="level-item">2.1.11</span><span class="level-item">lndex Template</span></span></a></li></ul></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/images/avatar/sasuke.jpg" alt="Appolostar"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Appolostar</p><p class="is-size-6 is-block">但行好事，莫问前程</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>The junction of Teyvat and Demacia</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">5</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/appolostar" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/appolostar"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="level-start"><span class="level-item">数据库</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/ElasticSearch/"><span class="level-start"><span class="level-item">ElasticSearch</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/PostgreSQL/"><span class="level-start"><span class="level-item">PostgreSQL</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://github.com/appolostar" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Shaway github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo/sasuke.png" alt="shaway" height="28"></a><p class="is-size-7"><span>&copy; 2022 shaway</span>  Powered by <a href="https://github.com/ShawayL" target="_blank" rel="noopener">Shaway</a> &amp; <a href="https://github.com/appolostar" target="_blank" rel="noopener">Q sang</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ShawayL/ShawayL.github.io"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>